name: Dependency Management

on:
  schedule:
    - cron: '0 8 * * MON'  # Weekly on Mondays at 8 AM UTC
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '20.x'

jobs:
  # Check for outdated dependencies
  check-updates:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for outdated packages
      run: |
        npm outdated --json > outdated.json || true
        echo "Outdated packages:"
        cat outdated.json | jq -r 'keys[]' || echo "No outdated packages found"

    - name: Upload outdated report
      uses: actions/upload-artifact@v6
      with:
        name: outdated-report
        path: outdated.json

  # Update patch and minor versions
  auto-update-safe:
    runs-on: ubuntu-latest
    needs: check-updates

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Configure git
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Update patch versions
      run: |
        npm update

    - name: Run tests after update
      run: |
        npm ci
        npm test || exit 1

    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet package*.json; then
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Create pull request for safe updates
      if: steps.changes.outputs.changes == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const branchName = `automated/dependency-updates-${Date.now()}`;

          // Create and push branch
          await exec.exec('git', ['checkout', '-b', branchName]);
          await exec.exec('git', ['add', 'package*.json']);
          await exec.exec('git', ['commit', '-m', `chore: update dependencies (patch/minor versions)

          - Automated dependency updates
          - Only patch and minor version updates
          - All tests passing

          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>`]);
          await exec.exec('git', ['push', 'origin', branchName]);

          // Create PR
          await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”„ Automated Dependency Updates',
            head: branchName,
            base: 'main',
            body: `## Automated Dependency Updates

          This PR contains automated updates for patch and minor versions of dependencies.

          ### What Changed
          - Updated package.json and package-lock.json
          - Only safe updates (patch and minor versions)
          - All existing tests are passing

          ### Verification
          - âœ… Tests are passing
          - âœ… Build is successful
          - âœ… No breaking changes expected

          ### Review Notes
          Please review the changes and ensure everything looks correct before merging.

          **Auto-generated by GitHub Actions**`
          });

  # Check for security updates
  security-updates:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Configure git
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Check for security vulnerabilities
      run: |
        npm audit --json > audit.json || true
        if [ -f audit.json ] && [ -s audit.json ]; then
          VULNS=$(cat audit.json | jq '.metadata.vulnerabilities.moderate + .metadata.vulnerabilities.high + .metadata.vulnerabilities.critical' || echo "0")
          echo "Found $VULNS vulnerabilities"
          echo "VULNERABILITY_COUNT=$VULNS" >> $GITHUB_ENV
        else
          echo "VULNERABILITY_COUNT=0" >> $GITHUB_ENV
        fi

    - name: Apply security fixes
      if: env.VULNERABILITY_COUNT != '0'
      run: |
        npm audit fix
        npm ci  # Verify installation works

    - name: Run tests after security fixes
      if: env.VULNERABILITY_COUNT != '0'
      run: npm test

    - name: Create security update PR
      if: env.VULNERABILITY_COUNT != '0'
      uses: actions/github-script@v6
      with:
        script: |
          const { execSync } = require('child_process');

          // Check if there are changes
          try {
            execSync('git diff --quiet package*.json');
            console.log('No changes to commit');
            return;
          } catch (error) {
            // Changes exist, continue
          }

          const branchName = `security/dependency-fixes-${Date.now()}`;
          const vulnCount = process.env.VULNERABILITY_COUNT;

          await exec.exec('git', ['checkout', '-b', branchName]);
          await exec.exec('git', ['add', 'package*.json']);
          await exec.exec('git', ['commit', '-m', `security: fix dependency vulnerabilities

          - Applied npm audit fix
          - Resolved ${vulnCount} vulnerabilities
          - All tests passing

          Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>`]);
          await exec.exec('git', ['push', 'origin', branchName]);

          await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ”’ Security: Fix Dependency Vulnerabilities',
            head: branchName,
            base: 'main',
            body: `## Security Dependency Fixes

          This PR addresses security vulnerabilities found in dependencies.

          ### Security Issues Fixed
          - **Vulnerabilities Resolved**: ${vulnCount}
          - Applied \`npm audit fix\` to resolve issues

          ### Verification
          - âœ… Tests are passing
          - âœ… Build is successful
          - âœ… Security vulnerabilities addressed

          ### Priority
          **ðŸš¨ HIGH PRIORITY** - This PR addresses security vulnerabilities and should be reviewed and merged promptly.

          **Auto-generated by GitHub Actions**`
          });

  # Major version update notifications
  major-updates-notification:
    runs-on: ubuntu-latest
    needs: check-updates

    steps:
    - name: Download outdated report
      uses: actions/download-artifact@v6
      with:
        name: outdated-report

    - name: Check for major updates
      id: major-updates
      run: |
        if [ -f outdated.json ] && [ -s outdated.json ]; then
          MAJOR_UPDATES=$(cat outdated.json | jq -r 'to_entries[] | select(.value.type == "major") | .key' | tr '\n' ' ')
          if [ -n "$MAJOR_UPDATES" ]; then
            echo "major_updates=$MAJOR_UPDATES" >> $GITHUB_OUTPUT
            echo "has_major=true" >> $GITHUB_OUTPUT
          else
            echo "has_major=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_major=false" >> $GITHUB_OUTPUT
        fi

    - name: Create issue for major updates
      if: steps.major-updates.outputs.has_major == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          const majorUpdates = '${{ steps.major-updates.outputs.major_updates }}';
          const title = `ðŸ“¦ Major Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`;
          const body = `
          ## Major Dependency Updates Available

          The following packages have major version updates available that require manual review:

          **Packages with Major Updates**:
          ${majorUpdates.split(' ').filter(pkg => pkg).map(pkg => `- \`${pkg}\``).join('\n')}

          ### Action Required
          Major version updates may contain breaking changes and require manual review:

          1. **Review Changelog**: Check the changelog for each package
          2. **Test Compatibility**: Ensure compatibility with your codebase
          3. **Update Code**: Make necessary code changes if required
          4. **Update Dependencies**: Update packages one by one
          5. **Test Thoroughly**: Run comprehensive tests

          ### Commands to Update
          \`\`\`bash
          # Check specific package details
          yarn info <package-name> versions --json

          # Update specific package
          yarn add <package-name>@latest

          # Run tests after each update
          yarn test
          \`\`\`

          **Labels**: dependencies, major-update, manual-review
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['dependencies', 'major-update', 'manual-review']
          });

  # Generate dependency report
  generate-report:
    runs-on: ubuntu-latest
    needs: [check-updates, auto-update-safe, security-updates]
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Generate dependency tree
      run: |
        npm ci
        npm list --json > dependency-tree.json || true

    - name: Create dependency report
      run: |
        echo "# Dependency Report - $(date)" > dependency-report.md
        echo "" >> dependency-report.md

        echo "## Summary" >> dependency-report.md
        TOTAL_DEPS=$(cat package.json | jq '.dependencies | length')
        TOTAL_DEV_DEPS=$(cat package.json | jq '.devDependencies | length')
        echo "- **Production Dependencies**: $TOTAL_DEPS" >> dependency-report.md
        echo "- **Development Dependencies**: $TOTAL_DEV_DEPS" >> dependency-report.md
        echo "" >> dependency-report.md

        echo "## Recent Changes" >> dependency-report.md
        echo "Check the workflow logs for details on any automated updates applied." >> dependency-report.md

    - name: Upload dependency report
      uses: actions/upload-artifact@v6
      with:
        name: dependency-report
        path: |
          dependency-report.md
          dependency-tree.json